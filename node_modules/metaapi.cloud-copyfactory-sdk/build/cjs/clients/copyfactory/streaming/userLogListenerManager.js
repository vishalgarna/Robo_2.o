"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, /**
 * User log event listener manager
 */ "default", {
    enumerable: true,
    get: function() {
        return UserLogListenerManager;
    }
});
const _metaapiclient = /*#__PURE__*/ _interop_require_default(require("../../metaapi.client"));
const _randomstring = /*#__PURE__*/ _interop_require_default(require("randomstring"));
const _logger = /*#__PURE__*/ _interop_require_default(require("../../../logger"));
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
let UserLogListenerManager = class UserLogListenerManager extends _metaapiclient.default {
    /**
   * Constructs user log event listener manager instance
   * @param {DomainClient} domainClient domain client
   */ constructor(domainClient){
        super(domainClient);
        this._domainClient = domainClient;
        this._strategyLogListeners = {};
        this._subscriberLogListeners = {};
        this._errorThrottleTime = 1000;
        this._logger = _logger.default.getLogger("UserLogListenerManager");
    }
    /**
   * Returns the dictionary of strategy log listeners
   * @returns {Object} dictionary of strategy log listeners
   */ get strategyLogListeners() {
        return this._strategyLogListeners;
    }
    /**
   * Returns the dictionary of subscriber log listeners
   * @returns {Object} dictionary of subscriber log listeners
   */ get subscriberLogListeners() {
        return this._subscriberLogListeners;
    }
    /**
   * Adds a strategy log listener
   * @param {UserLogListener} listener user log listener
   * @param {String} strategyId strategy id
   * @param {Date} [startTime] log search start time
   * @param {String} [positionId] position id filter
   * @param {'DEBUG'|'INFO'|'WARN'|'ERROR'} [level] minimum severity level
   * @param {Number} [limit] log pagination limit
   * @returns {String} strategy log listener id
   */ addStrategyLogListener(listener, strategyId, startTime, positionId, level, limit) {
        const listenerId = _randomstring.default.generate(10);
        this._strategyLogListeners[listenerId] = listener;
        this._startStrategyLogStreamJob(listenerId, listener, strategyId, startTime, positionId, level, limit);
        return listenerId;
    }
    /**
   * Adds a subscriber log listener
   * @param {UserLogListener} listener user log listener
   * @param {String} subscriberId subscriber id
   * @param {Date} [startTime] log search start time
   * @param {string} [strategyId] strategy id filter
   * @param {string} [positionId] position id filter
   * @param {'DEBUG'|'INFO'|'WARN'|'ERROR'} [level] minimum severity level
   * @param {Number} [limit] log pagination limit
   * @returns {String} subscriber log listener id
   */ addSubscriberLogListener(listener, subscriberId, startTime, strategyId, positionId, level, limit) {
        const listenerId = _randomstring.default.generate(10);
        this._subscriberLogListeners[listenerId] = listener;
        this._startSubscriberLogStreamJob(listenerId, listener, subscriberId, startTime, strategyId, positionId, level, limit);
        return listenerId;
    }
    /**
   * Removes strategy log listener by id
   * @param {String} listenerId listener id 
   */ removeStrategyLogListener(listenerId) {
        delete this._strategyLogListeners[listenerId];
    }
    /**
   * Removes subscriber log listener by id
   * @param {String} listenerId listener id 
   */ removeSubscriberLogListener(listenerId) {
        delete this._subscriberLogListeners[listenerId];
    }
    async _startStrategyLogStreamJob(listenerId, listener, strategyId, startTime, positionId, level, limit) {
        let throttleTime = this._errorThrottleTime;
        while(this._strategyLogListeners[listenerId]){
            const opts = {
                url: `/users/current/strategies/${strategyId}/user-log/stream`,
                method: "GET",
                params: {
                    startTime,
                    positionId,
                    level,
                    limit
                },
                headers: {
                    "auth-token": this._token
                },
                json: true
            };
            try {
                const packets = await this._domainClient.requestCopyFactory(opts, true);
                // stop job if user has unsubscribed in time of new packets has been received
                if (!this._strategyLogListeners[listenerId]) {
                    return;
                }
                await listener.onUserLog(packets);
                throttleTime = this._errorThrottleTime;
                if (this._strategyLogListeners[listenerId] && packets.length) {
                    startTime = new Date(new Date(packets[0].time).getTime() + 1);
                }
            } catch (err) {
                await listener.onError(err);
                if (err.name === "NotFoundError") {
                    this._logger.error(`Strategy ${strategyId} not found, removing listener ${listenerId}`);
                    delete this._strategyLogListeners[listenerId];
                } else {
                    this._logger.error(`Failed to retrieve user log stream for strategy ${strategyId}, ` + `listener ${listenerId}, retrying in ${Math.floor(throttleTime / 1000)} seconds`, err);
                    await new Promise((res)=>setTimeout(res, throttleTime));
                    throttleTime = Math.min(throttleTime * 2, 30000);
                }
            }
        }
    }
    async _startSubscriberLogStreamJob(listenerId, listener, subscriberId, startTime, strategyId, positionId, level, limit) {
        let throttleTime = this._errorThrottleTime;
        while(this._subscriberLogListeners[listenerId]){
            const opts = {
                url: `/users/current/subscribers/${subscriberId}/user-log/stream`,
                method: "GET",
                params: {
                    startTime,
                    strategyId,
                    positionId,
                    level,
                    limit
                },
                headers: {
                    "auth-token": this._token
                },
                json: true
            };
            try {
                const packets = await this._domainClient.requestCopyFactory(opts, true);
                // stop job if user has unsubscribed in time of new packets has been received
                if (!this._subscriberLogListeners[listenerId]) {
                    return;
                }
                await listener.onUserLog(packets);
                throttleTime = this._errorThrottleTime;
                if (this._subscriberLogListeners[listenerId] && packets.length) {
                    startTime = new Date(new Date(packets[0].time).getTime() + 1);
                }
            } catch (err) {
                await listener.onError(err);
                if (err.name === "NotFoundError") {
                    this._logger.error(`Subscriber ${subscriberId} not found, removing listener ${listenerId}`);
                    delete this._subscriberLogListeners[listenerId];
                } else {
                    this._logger.error(`Failed to retrieve user log stream for subscriber ${subscriberId}, ` + `listener ${listenerId}, retrying in ${Math.floor(throttleTime / 1000)} seconds`, err);
                    await new Promise((res)=>setTimeout(res, throttleTime));
                    throttleTime = Math.min(throttleTime * 2, 30000);
                }
            }
        }
    }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIjxhbm9uPiJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCBNZXRhQXBpQ2xpZW50IGZyb20gJy4uLy4uL21ldGFhcGkuY2xpZW50JztcbmltcG9ydCByYW5kb21zdHJpbmcgZnJvbSAncmFuZG9tc3RyaW5nJztcbmltcG9ydCBMb2dnZXJNYW5hZ2VyIGZyb20gJy4uLy4uLy4uL2xvZ2dlcic7XG5cbi8qKlxuICogVXNlciBsb2cgZXZlbnQgbGlzdGVuZXIgbWFuYWdlclxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBVc2VyTG9nTGlzdGVuZXJNYW5hZ2VyIGV4dGVuZHMgTWV0YUFwaUNsaWVudCB7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgdXNlciBsb2cgZXZlbnQgbGlzdGVuZXIgbWFuYWdlciBpbnN0YW5jZVxuICAgKiBAcGFyYW0ge0RvbWFpbkNsaWVudH0gZG9tYWluQ2xpZW50IGRvbWFpbiBjbGllbnRcbiAgICovXG4gIGNvbnN0cnVjdG9yKGRvbWFpbkNsaWVudCkge1xuICAgIHN1cGVyKGRvbWFpbkNsaWVudCk7XG4gICAgdGhpcy5fZG9tYWluQ2xpZW50ID0gZG9tYWluQ2xpZW50O1xuICAgIHRoaXMuX3N0cmF0ZWd5TG9nTGlzdGVuZXJzID0ge307XG4gICAgdGhpcy5fc3Vic2NyaWJlckxvZ0xpc3RlbmVycyA9IHt9O1xuICAgIHRoaXMuX2Vycm9yVGhyb3R0bGVUaW1lID0gMTAwMDtcbiAgICB0aGlzLl9sb2dnZXIgPSBMb2dnZXJNYW5hZ2VyLmdldExvZ2dlcignVXNlckxvZ0xpc3RlbmVyTWFuYWdlcicpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGRpY3Rpb25hcnkgb2Ygc3RyYXRlZ3kgbG9nIGxpc3RlbmVyc1xuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBkaWN0aW9uYXJ5IG9mIHN0cmF0ZWd5IGxvZyBsaXN0ZW5lcnNcbiAgICovXG4gIGdldCBzdHJhdGVneUxvZ0xpc3RlbmVycygpIHtcbiAgICByZXR1cm4gdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgZGljdGlvbmFyeSBvZiBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lcnNcbiAgICogQHJldHVybnMge09iamVjdH0gZGljdGlvbmFyeSBvZiBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lcnNcbiAgICovXG4gIGdldCBzdWJzY3JpYmVyTG9nTGlzdGVuZXJzKCkge1xuICAgIHJldHVybiB0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBzdHJhdGVneSBsb2cgbGlzdGVuZXJcbiAgICogQHBhcmFtIHtVc2VyTG9nTGlzdGVuZXJ9IGxpc3RlbmVyIHVzZXIgbG9nIGxpc3RlbmVyXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJhdGVneUlkIHN0cmF0ZWd5IGlkXG4gICAqIEBwYXJhbSB7RGF0ZX0gW3N0YXJ0VGltZV0gbG9nIHNlYXJjaCBzdGFydCB0aW1lXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBbcG9zaXRpb25JZF0gcG9zaXRpb24gaWQgZmlsdGVyXG4gICAqIEBwYXJhbSB7J0RFQlVHJ3wnSU5GTyd8J1dBUk4nfCdFUlJPUid9IFtsZXZlbF0gbWluaW11bSBzZXZlcml0eSBsZXZlbFxuICAgKiBAcGFyYW0ge051bWJlcn0gW2xpbWl0XSBsb2cgcGFnaW5hdGlvbiBsaW1pdFxuICAgKiBAcmV0dXJucyB7U3RyaW5nfSBzdHJhdGVneSBsb2cgbGlzdGVuZXIgaWRcbiAgICovXG4gIGFkZFN0cmF0ZWd5TG9nTGlzdGVuZXIobGlzdGVuZXIsIHN0cmF0ZWd5SWQsIHN0YXJ0VGltZSwgcG9zaXRpb25JZCwgbGV2ZWwsIGxpbWl0KSB7XG4gICAgY29uc3QgbGlzdGVuZXJJZCA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSgxMCk7XG4gICAgdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF0gPSBsaXN0ZW5lcjtcbiAgICB0aGlzLl9zdGFydFN0cmF0ZWd5TG9nU3RyZWFtSm9iKGxpc3RlbmVySWQsIGxpc3RlbmVyLCBzdHJhdGVneUlkLCBzdGFydFRpbWUsIHBvc2l0aW9uSWQsIGxldmVsLCBsaW1pdCk7XG4gICAgcmV0dXJuIGxpc3RlbmVySWQ7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIHN1YnNjcmliZXIgbG9nIGxpc3RlbmVyXG4gICAqIEBwYXJhbSB7VXNlckxvZ0xpc3RlbmVyfSBsaXN0ZW5lciB1c2VyIGxvZyBsaXN0ZW5lclxuICAgKiBAcGFyYW0ge1N0cmluZ30gc3Vic2NyaWJlcklkIHN1YnNjcmliZXIgaWRcbiAgICogQHBhcmFtIHtEYXRlfSBbc3RhcnRUaW1lXSBsb2cgc2VhcmNoIHN0YXJ0IHRpbWVcbiAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJhdGVneUlkXSBzdHJhdGVneSBpZCBmaWx0ZXJcbiAgICogQHBhcmFtIHtzdHJpbmd9IFtwb3NpdGlvbklkXSBwb3NpdGlvbiBpZCBmaWx0ZXJcbiAgICogQHBhcmFtIHsnREVCVUcnfCdJTkZPJ3wnV0FSTid8J0VSUk9SJ30gW2xldmVsXSBtaW5pbXVtIHNldmVyaXR5IGxldmVsXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBbbGltaXRdIGxvZyBwYWdpbmF0aW9uIGxpbWl0XG4gICAqIEByZXR1cm5zIHtTdHJpbmd9IHN1YnNjcmliZXIgbG9nIGxpc3RlbmVyIGlkXG4gICAqL1xuICBhZGRTdWJzY3JpYmVyTG9nTGlzdGVuZXIobGlzdGVuZXIsIHN1YnNjcmliZXJJZCwgc3RhcnRUaW1lLCBzdHJhdGVneUlkLCBwb3NpdGlvbklkLCBsZXZlbCwgbGltaXQpIHtcbiAgICBjb25zdCBsaXN0ZW5lcklkID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKDEwKTtcbiAgICB0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdID0gbGlzdGVuZXI7XG4gICAgdGhpcy5fc3RhcnRTdWJzY3JpYmVyTG9nU3RyZWFtSm9iKFxuICAgICAgbGlzdGVuZXJJZCwgXG4gICAgICBsaXN0ZW5lciwgXG4gICAgICBzdWJzY3JpYmVySWQsIFxuICAgICAgc3RhcnRUaW1lLCBcbiAgICAgIHN0cmF0ZWd5SWQsIFxuICAgICAgcG9zaXRpb25JZCwgXG4gICAgICBsZXZlbCwgXG4gICAgICBsaW1pdFxuICAgICk7XG4gICAgcmV0dXJuIGxpc3RlbmVySWQ7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBzdHJhdGVneSBsb2cgbGlzdGVuZXIgYnkgaWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGxpc3RlbmVySWQgbGlzdGVuZXIgaWQgXG4gICAqL1xuICByZW1vdmVTdHJhdGVneUxvZ0xpc3RlbmVyKGxpc3RlbmVySWQpIHtcbiAgICBkZWxldGUgdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF07XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lciBieSBpZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gbGlzdGVuZXJJZCBsaXN0ZW5lciBpZCBcbiAgICovXG4gIHJlbW92ZVN1YnNjcmliZXJMb2dMaXN0ZW5lcihsaXN0ZW5lcklkKSB7XG4gICAgZGVsZXRlIHRoaXMuX3N1YnNjcmliZXJMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF07XG4gIH1cblxuICBhc3luYyBfc3RhcnRTdHJhdGVneUxvZ1N0cmVhbUpvYihsaXN0ZW5lcklkLCBsaXN0ZW5lciwgc3RyYXRlZ3lJZCwgc3RhcnRUaW1lLCBwb3NpdGlvbklkLCBsZXZlbCwgbGltaXQpIHtcbiAgICBsZXQgdGhyb3R0bGVUaW1lID0gdGhpcy5fZXJyb3JUaHJvdHRsZVRpbWU7XG5cbiAgICB3aGlsZSh0aGlzLl9zdHJhdGVneUxvZ0xpc3RlbmVyc1tsaXN0ZW5lcklkXSkge1xuICAgICAgY29uc3Qgb3B0cyA9IHtcbiAgICAgICAgdXJsOiBgL3VzZXJzL2N1cnJlbnQvc3RyYXRlZ2llcy8ke3N0cmF0ZWd5SWR9L3VzZXItbG9nL3N0cmVhbWAsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHBhcmFtczoge1xuICAgICAgICAgIHN0YXJ0VGltZSxcbiAgICAgICAgICBwb3NpdGlvbklkLFxuICAgICAgICAgIGxldmVsLFxuICAgICAgICAgIGxpbWl0XG4gICAgICAgIH0sXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICAgIH0sXG4gICAgICAgIGpzb246IHRydWVcbiAgICAgIH07XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBwYWNrZXRzID0gYXdhaXQgdGhpcy5fZG9tYWluQ2xpZW50LnJlcXVlc3RDb3B5RmFjdG9yeShvcHRzLCB0cnVlKTtcbiAgICAgICAgLy8gc3RvcCBqb2IgaWYgdXNlciBoYXMgdW5zdWJzY3JpYmVkIGluIHRpbWUgb2YgbmV3IHBhY2tldHMgaGFzIGJlZW4gcmVjZWl2ZWRcbiAgICAgICAgaWYgKCF0aGlzLl9zdHJhdGVneUxvZ0xpc3RlbmVyc1tsaXN0ZW5lcklkXSkgeyByZXR1cm47IH1cbiAgICAgICAgYXdhaXQgbGlzdGVuZXIub25Vc2VyTG9nKHBhY2tldHMpO1xuICAgICAgICB0aHJvdHRsZVRpbWUgPSB0aGlzLl9lcnJvclRocm90dGxlVGltZTtcbiAgICAgICAgaWYodGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF0gJiYgcGFja2V0cy5sZW5ndGgpIHtcbiAgICAgICAgICBzdGFydFRpbWUgPSBuZXcgRGF0ZShuZXcgRGF0ZShwYWNrZXRzWzBdLnRpbWUpLmdldFRpbWUoKSArIDEpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgYXdhaXQgbGlzdGVuZXIub25FcnJvcihlcnIpO1xuICAgICAgICBpZiAoZXJyLm5hbWUgPT09ICdOb3RGb3VuZEVycm9yJykge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgU3RyYXRlZ3kgJHtzdHJhdGVneUlkfSBub3QgZm91bmQsIHJlbW92aW5nIGxpc3RlbmVyICR7bGlzdGVuZXJJZH1gKTtcbiAgICAgICAgICBkZWxldGUgdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF07IFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgRmFpbGVkIHRvIHJldHJpZXZlIHVzZXIgbG9nIHN0cmVhbSBmb3Igc3RyYXRlZ3kgJHtzdHJhdGVneUlkfSwgYCArXG4gICAgICAgICAgICBgbGlzdGVuZXIgJHtsaXN0ZW5lcklkfSwgcmV0cnlpbmcgaW4gJHtNYXRoLmZsb29yKHRocm90dGxlVGltZS8xMDAwKX0gc2Vjb25kc2AsIGVycik7XG4gICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCB0aHJvdHRsZVRpbWUpKTtcbiAgICAgICAgICB0aHJvdHRsZVRpbWUgPSBNYXRoLm1pbih0aHJvdHRsZVRpbWUgKiAyLCAzMDAwMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBfc3RhcnRTdWJzY3JpYmVyTG9nU3RyZWFtSm9iKFxuICAgIGxpc3RlbmVySWQsIFxuICAgIGxpc3RlbmVyLCBcbiAgICBzdWJzY3JpYmVySWQsIFxuICAgIHN0YXJ0VGltZSwgXG4gICAgc3RyYXRlZ3lJZCwgXG4gICAgcG9zaXRpb25JZCwgXG4gICAgbGV2ZWwsIFxuICAgIGxpbWl0XG4gICkge1xuICAgIGxldCB0aHJvdHRsZVRpbWUgPSB0aGlzLl9lcnJvclRocm90dGxlVGltZTtcblxuICAgIHdoaWxlKHRoaXMuX3N1YnNjcmliZXJMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF0pIHtcbiAgICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICAgIHVybDogYC91c2Vycy9jdXJyZW50L3N1YnNjcmliZXJzLyR7c3Vic2NyaWJlcklkfS91c2VyLWxvZy9zdHJlYW1gLFxuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgICAgc3RyYXRlZ3lJZCxcbiAgICAgICAgICBwb3NpdGlvbklkLFxuICAgICAgICAgIGxldmVsLFxuICAgICAgICAgIGxpbWl0XG4gICAgICAgIH0sXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICAgIH0sXG4gICAgICAgIGpzb246IHRydWVcbiAgICAgIH07XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBwYWNrZXRzID0gYXdhaXQgdGhpcy5fZG9tYWluQ2xpZW50LnJlcXVlc3RDb3B5RmFjdG9yeShvcHRzLCB0cnVlKTtcbiAgICAgICAgLy8gc3RvcCBqb2IgaWYgdXNlciBoYXMgdW5zdWJzY3JpYmVkIGluIHRpbWUgb2YgbmV3IHBhY2tldHMgaGFzIGJlZW4gcmVjZWl2ZWRcbiAgICAgICAgaWYgKCF0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdKSB7IHJldHVybjsgfVxuICAgICAgICBhd2FpdCBsaXN0ZW5lci5vblVzZXJMb2cocGFja2V0cyk7XG4gICAgICAgIHRocm90dGxlVGltZSA9IHRoaXMuX2Vycm9yVGhyb3R0bGVUaW1lO1xuICAgICAgICBpZih0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdICYmIHBhY2tldHMubGVuZ3RoKSB7XG4gICAgICAgICAgc3RhcnRUaW1lID0gbmV3IERhdGUobmV3IERhdGUocGFja2V0c1swXS50aW1lKS5nZXRUaW1lKCkgKyAxKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGF3YWl0IGxpc3RlbmVyLm9uRXJyb3IoZXJyKTtcbiAgICAgICAgaWYgKGVyci5uYW1lID09PSAnTm90Rm91bmRFcnJvcicpIHtcbiAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYFN1YnNjcmliZXIgJHtzdWJzY3JpYmVySWR9IG5vdCBmb3VuZCwgcmVtb3ZpbmcgbGlzdGVuZXIgJHtsaXN0ZW5lcklkfWApO1xuICAgICAgICAgIGRlbGV0ZSB0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdOyBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byByZXRyaWV2ZSB1c2VyIGxvZyBzdHJlYW0gZm9yIHN1YnNjcmliZXIgJHtzdWJzY3JpYmVySWR9LCBgICtcbiAgICAgICAgICAgIGBsaXN0ZW5lciAke2xpc3RlbmVySWR9LCByZXRyeWluZyBpbiAke01hdGguZmxvb3IodGhyb3R0bGVUaW1lLzEwMDApfSBzZWNvbmRzYCwgZXJyKTtcbiAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIHRocm90dGxlVGltZSkpO1xuICAgICAgICAgIHRocm90dGxlVGltZSA9IE1hdGgubWluKHRocm90dGxlVGltZSAqIDIsIDMwMDAwKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG59XG4iXSwibmFtZXMiOlsiVXNlckxvZ0xpc3RlbmVyTWFuYWdlciIsIk1ldGFBcGlDbGllbnQiLCJjb25zdHJ1Y3RvciIsImRvbWFpbkNsaWVudCIsIl9kb21haW5DbGllbnQiLCJfc3RyYXRlZ3lMb2dMaXN0ZW5lcnMiLCJfc3Vic2NyaWJlckxvZ0xpc3RlbmVycyIsIl9lcnJvclRocm90dGxlVGltZSIsIl9sb2dnZXIiLCJMb2dnZXJNYW5hZ2VyIiwiZ2V0TG9nZ2VyIiwic3RyYXRlZ3lMb2dMaXN0ZW5lcnMiLCJzdWJzY3JpYmVyTG9nTGlzdGVuZXJzIiwiYWRkU3RyYXRlZ3lMb2dMaXN0ZW5lciIsImxpc3RlbmVyIiwic3RyYXRlZ3lJZCIsInN0YXJ0VGltZSIsInBvc2l0aW9uSWQiLCJsZXZlbCIsImxpbWl0IiwibGlzdGVuZXJJZCIsInJhbmRvbXN0cmluZyIsImdlbmVyYXRlIiwiX3N0YXJ0U3RyYXRlZ3lMb2dTdHJlYW1Kb2IiLCJhZGRTdWJzY3JpYmVyTG9nTGlzdGVuZXIiLCJzdWJzY3JpYmVySWQiLCJfc3RhcnRTdWJzY3JpYmVyTG9nU3RyZWFtSm9iIiwicmVtb3ZlU3RyYXRlZ3lMb2dMaXN0ZW5lciIsInJlbW92ZVN1YnNjcmliZXJMb2dMaXN0ZW5lciIsInRocm90dGxlVGltZSIsIm9wdHMiLCJ1cmwiLCJtZXRob2QiLCJwYXJhbXMiLCJoZWFkZXJzIiwiX3Rva2VuIiwianNvbiIsInBhY2tldHMiLCJyZXF1ZXN0Q29weUZhY3RvcnkiLCJvblVzZXJMb2ciLCJsZW5ndGgiLCJEYXRlIiwidGltZSIsImdldFRpbWUiLCJlcnIiLCJvbkVycm9yIiwibmFtZSIsImVycm9yIiwiTWF0aCIsImZsb29yIiwiUHJvbWlzZSIsInJlcyIsInNldFRpbWVvdXQiLCJtaW4iXSwibWFwcGluZ3MiOiJBQUFBOzs7OytCQU1BOztDQUVDLEdBQ0Q7OztlQUFxQkE7OztzRUFQSztxRUFDRDsrREFDQzs7Ozs7O0FBS1gsSUFBQSxBQUFNQSx5QkFBTixNQUFNQSwrQkFBK0JDLHNCQUFhO0lBRS9EOzs7R0FHQyxHQUNEQyxZQUFZQyxZQUFZLENBQUU7UUFDeEIsS0FBSyxDQUFDQTtRQUNOLElBQUksQ0FBQ0MsYUFBYSxHQUFHRDtRQUNyQixJQUFJLENBQUNFLHFCQUFxQixHQUFHLENBQUM7UUFDOUIsSUFBSSxDQUFDQyx1QkFBdUIsR0FBRyxDQUFDO1FBQ2hDLElBQUksQ0FBQ0Msa0JBQWtCLEdBQUc7UUFDMUIsSUFBSSxDQUFDQyxPQUFPLEdBQUdDLGVBQWEsQ0FBQ0MsU0FBUyxDQUFDO0lBQ3pDO0lBRUE7OztHQUdDLEdBQ0QsSUFBSUMsdUJBQXVCO1FBQ3pCLE9BQU8sSUFBSSxDQUFDTixxQkFBcUI7SUFDbkM7SUFFQTs7O0dBR0MsR0FDRCxJQUFJTyx5QkFBeUI7UUFDM0IsT0FBTyxJQUFJLENBQUNOLHVCQUF1QjtJQUNyQztJQUVBOzs7Ozs7Ozs7R0FTQyxHQUNETyx1QkFBdUJDLFFBQVEsRUFBRUMsVUFBVSxFQUFFQyxTQUFTLEVBQUVDLFVBQVUsRUFBRUMsS0FBSyxFQUFFQyxLQUFLLEVBQUU7UUFDaEYsTUFBTUMsYUFBYUMscUJBQVksQ0FBQ0MsUUFBUSxDQUFDO1FBQ3pDLElBQUksQ0FBQ2pCLHFCQUFxQixDQUFDZSxXQUFXLEdBQUdOO1FBQ3pDLElBQUksQ0FBQ1MsMEJBQTBCLENBQUNILFlBQVlOLFVBQVVDLFlBQVlDLFdBQVdDLFlBQVlDLE9BQU9DO1FBQ2hHLE9BQU9DO0lBQ1Q7SUFFQTs7Ozs7Ozs7OztHQVVDLEdBQ0RJLHlCQUF5QlYsUUFBUSxFQUFFVyxZQUFZLEVBQUVULFNBQVMsRUFBRUQsVUFBVSxFQUFFRSxVQUFVLEVBQUVDLEtBQUssRUFBRUMsS0FBSyxFQUFFO1FBQ2hHLE1BQU1DLGFBQWFDLHFCQUFZLENBQUNDLFFBQVEsQ0FBQztRQUN6QyxJQUFJLENBQUNoQix1QkFBdUIsQ0FBQ2MsV0FBVyxHQUFHTjtRQUMzQyxJQUFJLENBQUNZLDRCQUE0QixDQUMvQk4sWUFDQU4sVUFDQVcsY0FDQVQsV0FDQUQsWUFDQUUsWUFDQUMsT0FDQUM7UUFFRixPQUFPQztJQUNUO0lBRUE7OztHQUdDLEdBQ0RPLDBCQUEwQlAsVUFBVSxFQUFFO1FBQ3BDLE9BQU8sSUFBSSxDQUFDZixxQkFBcUIsQ0FBQ2UsV0FBVztJQUMvQztJQUVBOzs7R0FHQyxHQUNEUSw0QkFBNEJSLFVBQVUsRUFBRTtRQUN0QyxPQUFPLElBQUksQ0FBQ2QsdUJBQXVCLENBQUNjLFdBQVc7SUFDakQ7SUFFQSxNQUFNRywyQkFBMkJILFVBQVUsRUFBRU4sUUFBUSxFQUFFQyxVQUFVLEVBQUVDLFNBQVMsRUFBRUMsVUFBVSxFQUFFQyxLQUFLLEVBQUVDLEtBQUssRUFBRTtRQUN0RyxJQUFJVSxlQUFlLElBQUksQ0FBQ3RCLGtCQUFrQjtRQUUxQyxNQUFNLElBQUksQ0FBQ0YscUJBQXFCLENBQUNlLFdBQVcsQ0FBRTtZQUM1QyxNQUFNVSxPQUFPO2dCQUNYQyxLQUFLLENBQUMsMEJBQTBCLEVBQUVoQixXQUFXLGdCQUFnQixDQUFDO2dCQUM5RGlCLFFBQVE7Z0JBQ1JDLFFBQVE7b0JBQ05qQjtvQkFDQUM7b0JBQ0FDO29CQUNBQztnQkFDRjtnQkFDQWUsU0FBUztvQkFDUCxjQUFjLElBQUksQ0FBQ0MsTUFBTTtnQkFDM0I7Z0JBQ0FDLE1BQU0sSUFBSTtZQUNaO1lBQ0EsSUFBSTtnQkFDRixNQUFNQyxVQUFVLE1BQU0sSUFBSSxDQUFDakMsYUFBYSxDQUFDa0Msa0JBQWtCLENBQUNSLE1BQU0sSUFBSTtnQkFDdEUsNkVBQTZFO2dCQUM3RSxJQUFJLENBQUMsSUFBSSxDQUFDekIscUJBQXFCLENBQUNlLFdBQVcsRUFBRTtvQkFBRTtnQkFBUSxDQUFDO2dCQUN4RCxNQUFNTixTQUFTeUIsU0FBUyxDQUFDRjtnQkFDekJSLGVBQWUsSUFBSSxDQUFDdEIsa0JBQWtCO2dCQUN0QyxJQUFHLElBQUksQ0FBQ0YscUJBQXFCLENBQUNlLFdBQVcsSUFBSWlCLFFBQVFHLE1BQU0sRUFBRTtvQkFDM0R4QixZQUFZLElBQUl5QixLQUFLLElBQUlBLEtBQUtKLE9BQU8sQ0FBQyxFQUFFLENBQUNLLElBQUksRUFBRUMsT0FBTyxLQUFLO2dCQUM3RCxDQUFDO1lBQ0gsRUFBRSxPQUFPQyxLQUFLO2dCQUNaLE1BQU05QixTQUFTK0IsT0FBTyxDQUFDRDtnQkFDdkIsSUFBSUEsSUFBSUUsSUFBSSxLQUFLLGlCQUFpQjtvQkFDaEMsSUFBSSxDQUFDdEMsT0FBTyxDQUFDdUMsS0FBSyxDQUFDLENBQUMsU0FBUyxFQUFFaEMsV0FBVyw4QkFBOEIsRUFBRUssV0FBVyxDQUFDO29CQUN0RixPQUFPLElBQUksQ0FBQ2YscUJBQXFCLENBQUNlLFdBQVc7Z0JBQy9DLE9BQU87b0JBQ0wsSUFBSSxDQUFDWixPQUFPLENBQUN1QyxLQUFLLENBQUMsQ0FBQyxnREFBZ0QsRUFBRWhDLFdBQVcsRUFBRSxDQUFDLEdBQ2xGLENBQUMsU0FBUyxFQUFFSyxXQUFXLGNBQWMsRUFBRTRCLEtBQUtDLEtBQUssQ0FBQ3BCLGVBQWEsTUFBTSxRQUFRLENBQUMsRUFBRWU7b0JBQ2xGLE1BQU0sSUFBSU0sUUFBUUMsQ0FBQUEsTUFBT0MsV0FBV0QsS0FBS3RCO29CQUN6Q0EsZUFBZW1CLEtBQUtLLEdBQUcsQ0FBQ3hCLGVBQWUsR0FBRztnQkFDNUMsQ0FBQztZQUNIO1FBQ0Y7SUFDRjtJQUVBLE1BQU1ILDZCQUNKTixVQUFVLEVBQ1ZOLFFBQVEsRUFDUlcsWUFBWSxFQUNaVCxTQUFTLEVBQ1RELFVBQVUsRUFDVkUsVUFBVSxFQUNWQyxLQUFLLEVBQ0xDLEtBQUssRUFDTDtRQUNBLElBQUlVLGVBQWUsSUFBSSxDQUFDdEIsa0JBQWtCO1FBRTFDLE1BQU0sSUFBSSxDQUFDRCx1QkFBdUIsQ0FBQ2MsV0FBVyxDQUFFO1lBQzlDLE1BQU1VLE9BQU87Z0JBQ1hDLEtBQUssQ0FBQywyQkFBMkIsRUFBRU4sYUFBYSxnQkFBZ0IsQ0FBQztnQkFDakVPLFFBQVE7Z0JBQ1JDLFFBQVE7b0JBQ05qQjtvQkFDQUQ7b0JBQ0FFO29CQUNBQztvQkFDQUM7Z0JBQ0Y7Z0JBQ0FlLFNBQVM7b0JBQ1AsY0FBYyxJQUFJLENBQUNDLE1BQU07Z0JBQzNCO2dCQUNBQyxNQUFNLElBQUk7WUFDWjtZQUNBLElBQUk7Z0JBQ0YsTUFBTUMsVUFBVSxNQUFNLElBQUksQ0FBQ2pDLGFBQWEsQ0FBQ2tDLGtCQUFrQixDQUFDUixNQUFNLElBQUk7Z0JBQ3RFLDZFQUE2RTtnQkFDN0UsSUFBSSxDQUFDLElBQUksQ0FBQ3hCLHVCQUF1QixDQUFDYyxXQUFXLEVBQUU7b0JBQUU7Z0JBQVEsQ0FBQztnQkFDMUQsTUFBTU4sU0FBU3lCLFNBQVMsQ0FBQ0Y7Z0JBQ3pCUixlQUFlLElBQUksQ0FBQ3RCLGtCQUFrQjtnQkFDdEMsSUFBRyxJQUFJLENBQUNELHVCQUF1QixDQUFDYyxXQUFXLElBQUlpQixRQUFRRyxNQUFNLEVBQUU7b0JBQzdEeEIsWUFBWSxJQUFJeUIsS0FBSyxJQUFJQSxLQUFLSixPQUFPLENBQUMsRUFBRSxDQUFDSyxJQUFJLEVBQUVDLE9BQU8sS0FBSztnQkFDN0QsQ0FBQztZQUNILEVBQUUsT0FBT0MsS0FBSztnQkFDWixNQUFNOUIsU0FBUytCLE9BQU8sQ0FBQ0Q7Z0JBQ3ZCLElBQUlBLElBQUlFLElBQUksS0FBSyxpQkFBaUI7b0JBQ2hDLElBQUksQ0FBQ3RDLE9BQU8sQ0FBQ3VDLEtBQUssQ0FBQyxDQUFDLFdBQVcsRUFBRXRCLGFBQWEsOEJBQThCLEVBQUVMLFdBQVcsQ0FBQztvQkFDMUYsT0FBTyxJQUFJLENBQUNkLHVCQUF1QixDQUFDYyxXQUFXO2dCQUNqRCxPQUFPO29CQUNMLElBQUksQ0FBQ1osT0FBTyxDQUFDdUMsS0FBSyxDQUFDLENBQUMsa0RBQWtELEVBQUV0QixhQUFhLEVBQUUsQ0FBQyxHQUN0RixDQUFDLFNBQVMsRUFBRUwsV0FBVyxjQUFjLEVBQUU0QixLQUFLQyxLQUFLLENBQUNwQixlQUFhLE1BQU0sUUFBUSxDQUFDLEVBQUVlO29CQUNsRixNQUFNLElBQUlNLFFBQVFDLENBQUFBLE1BQU9DLFdBQVdELEtBQUt0QjtvQkFDekNBLGVBQWVtQixLQUFLSyxHQUFHLENBQUN4QixlQUFlLEdBQUc7Z0JBQzVDLENBQUM7WUFDSDtRQUNGO0lBQ0Y7QUFFRiJ9