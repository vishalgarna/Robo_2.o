'use strict';
function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {
    try {
        var info = gen[key](arg);
        var value = info.value;
    } catch (error) {
        reject(error);
        return;
    }
    if (info.done) {
        resolve(value);
    } else {
        Promise.resolve(value).then(_next, _throw);
    }
}
function _async_to_generator(fn) {
    return function() {
        var self = this, args = arguments;
        return new Promise(function(resolve, reject) {
            var gen = fn.apply(self, args);
            function _next(value) {
                asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value);
            }
            function _throw(err) {
                asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err);
            }
            _next(undefined);
        });
    };
}
import MetaApiClient from '../../metaapi.client';
import randomstring from 'randomstring';
import LoggerManager from '../../../logger';
let UserLogListenerManager = class UserLogListenerManager extends MetaApiClient {
    /**
   * Returns the dictionary of strategy log listeners
   * @returns {Object} dictionary of strategy log listeners
   */ get strategyLogListeners() {
        return this._strategyLogListeners;
    }
    /**
   * Returns the dictionary of subscriber log listeners
   * @returns {Object} dictionary of subscriber log listeners
   */ get subscriberLogListeners() {
        return this._subscriberLogListeners;
    }
    /**
   * Adds a strategy log listener
   * @param {UserLogListener} listener user log listener
   * @param {String} strategyId strategy id
   * @param {Date} [startTime] log search start time
   * @param {String} [positionId] position id filter
   * @param {'DEBUG'|'INFO'|'WARN'|'ERROR'} [level] minimum severity level
   * @param {Number} [limit] log pagination limit
   * @returns {String} strategy log listener id
   */ addStrategyLogListener(listener, strategyId, startTime, positionId, level, limit) {
        const listenerId = randomstring.generate(10);
        this._strategyLogListeners[listenerId] = listener;
        this._startStrategyLogStreamJob(listenerId, listener, strategyId, startTime, positionId, level, limit);
        return listenerId;
    }
    /**
   * Adds a subscriber log listener
   * @param {UserLogListener} listener user log listener
   * @param {String} subscriberId subscriber id
   * @param {Date} [startTime] log search start time
   * @param {string} [strategyId] strategy id filter
   * @param {string} [positionId] position id filter
   * @param {'DEBUG'|'INFO'|'WARN'|'ERROR'} [level] minimum severity level
   * @param {Number} [limit] log pagination limit
   * @returns {String} subscriber log listener id
   */ addSubscriberLogListener(listener, subscriberId, startTime, strategyId, positionId, level, limit) {
        const listenerId = randomstring.generate(10);
        this._subscriberLogListeners[listenerId] = listener;
        this._startSubscriberLogStreamJob(listenerId, listener, subscriberId, startTime, strategyId, positionId, level, limit);
        return listenerId;
    }
    /**
   * Removes strategy log listener by id
   * @param {String} listenerId listener id 
   */ removeStrategyLogListener(listenerId) {
        delete this._strategyLogListeners[listenerId];
    }
    /**
   * Removes subscriber log listener by id
   * @param {String} listenerId listener id 
   */ removeSubscriberLogListener(listenerId) {
        delete this._subscriberLogListeners[listenerId];
    }
    _startStrategyLogStreamJob(listenerId, listener, strategyId, startTime, positionId, level, limit) {
        var _this = this;
        return _async_to_generator(function*() {
            let throttleTime = _this._errorThrottleTime;
            while(_this._strategyLogListeners[listenerId]){
                const opts = {
                    url: `/users/current/strategies/${strategyId}/user-log/stream`,
                    method: 'GET',
                    params: {
                        startTime,
                        positionId,
                        level,
                        limit
                    },
                    headers: {
                        'auth-token': _this._token
                    },
                    json: true
                };
                try {
                    const packets = yield _this._domainClient.requestCopyFactory(opts, true);
                    // stop job if user has unsubscribed in time of new packets has been received
                    if (!_this._strategyLogListeners[listenerId]) {
                        return;
                    }
                    yield listener.onUserLog(packets);
                    throttleTime = _this._errorThrottleTime;
                    if (_this._strategyLogListeners[listenerId] && packets.length) {
                        startTime = new Date(new Date(packets[0].time).getTime() + 1);
                    }
                } catch (err) {
                    yield listener.onError(err);
                    if (err.name === 'NotFoundError') {
                        _this._logger.error(`Strategy ${strategyId} not found, removing listener ${listenerId}`);
                        delete _this._strategyLogListeners[listenerId];
                    } else {
                        _this._logger.error(`Failed to retrieve user log stream for strategy ${strategyId}, ` + `listener ${listenerId}, retrying in ${Math.floor(throttleTime / 1000)} seconds`, err);
                        yield new Promise((res)=>setTimeout(res, throttleTime));
                        throttleTime = Math.min(throttleTime * 2, 30000);
                    }
                }
            }
        })();
    }
    _startSubscriberLogStreamJob(listenerId, listener, subscriberId, startTime, strategyId, positionId, level, limit) {
        var _this = this;
        return _async_to_generator(function*() {
            let throttleTime = _this._errorThrottleTime;
            while(_this._subscriberLogListeners[listenerId]){
                const opts = {
                    url: `/users/current/subscribers/${subscriberId}/user-log/stream`,
                    method: 'GET',
                    params: {
                        startTime,
                        strategyId,
                        positionId,
                        level,
                        limit
                    },
                    headers: {
                        'auth-token': _this._token
                    },
                    json: true
                };
                try {
                    const packets = yield _this._domainClient.requestCopyFactory(opts, true);
                    // stop job if user has unsubscribed in time of new packets has been received
                    if (!_this._subscriberLogListeners[listenerId]) {
                        return;
                    }
                    yield listener.onUserLog(packets);
                    throttleTime = _this._errorThrottleTime;
                    if (_this._subscriberLogListeners[listenerId] && packets.length) {
                        startTime = new Date(new Date(packets[0].time).getTime() + 1);
                    }
                } catch (err) {
                    yield listener.onError(err);
                    if (err.name === 'NotFoundError') {
                        _this._logger.error(`Subscriber ${subscriberId} not found, removing listener ${listenerId}`);
                        delete _this._subscriberLogListeners[listenerId];
                    } else {
                        _this._logger.error(`Failed to retrieve user log stream for subscriber ${subscriberId}, ` + `listener ${listenerId}, retrying in ${Math.floor(throttleTime / 1000)} seconds`, err);
                        yield new Promise((res)=>setTimeout(res, throttleTime));
                        throttleTime = Math.min(throttleTime * 2, 30000);
                    }
                }
            }
        })();
    }
    /**
   * Constructs user log event listener manager instance
   * @param {DomainClient} domainClient domain client
   */ constructor(domainClient){
        super(domainClient);
        this._domainClient = domainClient;
        this._strategyLogListeners = {};
        this._subscriberLogListeners = {};
        this._errorThrottleTime = 1000;
        this._logger = LoggerManager.getLogger('UserLogListenerManager');
    }
};
/**
 * User log event listener manager
 */ export { UserLogListenerManager as default };

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIjxhbm9uPiJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCBNZXRhQXBpQ2xpZW50IGZyb20gJy4uLy4uL21ldGFhcGkuY2xpZW50JztcbmltcG9ydCByYW5kb21zdHJpbmcgZnJvbSAncmFuZG9tc3RyaW5nJztcbmltcG9ydCBMb2dnZXJNYW5hZ2VyIGZyb20gJy4uLy4uLy4uL2xvZ2dlcic7XG5cbi8qKlxuICogVXNlciBsb2cgZXZlbnQgbGlzdGVuZXIgbWFuYWdlclxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBVc2VyTG9nTGlzdGVuZXJNYW5hZ2VyIGV4dGVuZHMgTWV0YUFwaUNsaWVudCB7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgdXNlciBsb2cgZXZlbnQgbGlzdGVuZXIgbWFuYWdlciBpbnN0YW5jZVxuICAgKiBAcGFyYW0ge0RvbWFpbkNsaWVudH0gZG9tYWluQ2xpZW50IGRvbWFpbiBjbGllbnRcbiAgICovXG4gIGNvbnN0cnVjdG9yKGRvbWFpbkNsaWVudCkge1xuICAgIHN1cGVyKGRvbWFpbkNsaWVudCk7XG4gICAgdGhpcy5fZG9tYWluQ2xpZW50ID0gZG9tYWluQ2xpZW50O1xuICAgIHRoaXMuX3N0cmF0ZWd5TG9nTGlzdGVuZXJzID0ge307XG4gICAgdGhpcy5fc3Vic2NyaWJlckxvZ0xpc3RlbmVycyA9IHt9O1xuICAgIHRoaXMuX2Vycm9yVGhyb3R0bGVUaW1lID0gMTAwMDtcbiAgICB0aGlzLl9sb2dnZXIgPSBMb2dnZXJNYW5hZ2VyLmdldExvZ2dlcignVXNlckxvZ0xpc3RlbmVyTWFuYWdlcicpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGRpY3Rpb25hcnkgb2Ygc3RyYXRlZ3kgbG9nIGxpc3RlbmVyc1xuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBkaWN0aW9uYXJ5IG9mIHN0cmF0ZWd5IGxvZyBsaXN0ZW5lcnNcbiAgICovXG4gIGdldCBzdHJhdGVneUxvZ0xpc3RlbmVycygpIHtcbiAgICByZXR1cm4gdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgZGljdGlvbmFyeSBvZiBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lcnNcbiAgICogQHJldHVybnMge09iamVjdH0gZGljdGlvbmFyeSBvZiBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lcnNcbiAgICovXG4gIGdldCBzdWJzY3JpYmVyTG9nTGlzdGVuZXJzKCkge1xuICAgIHJldHVybiB0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBzdHJhdGVneSBsb2cgbGlzdGVuZXJcbiAgICogQHBhcmFtIHtVc2VyTG9nTGlzdGVuZXJ9IGxpc3RlbmVyIHVzZXIgbG9nIGxpc3RlbmVyXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJhdGVneUlkIHN0cmF0ZWd5IGlkXG4gICAqIEBwYXJhbSB7RGF0ZX0gW3N0YXJ0VGltZV0gbG9nIHNlYXJjaCBzdGFydCB0aW1lXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBbcG9zaXRpb25JZF0gcG9zaXRpb24gaWQgZmlsdGVyXG4gICAqIEBwYXJhbSB7J0RFQlVHJ3wnSU5GTyd8J1dBUk4nfCdFUlJPUid9IFtsZXZlbF0gbWluaW11bSBzZXZlcml0eSBsZXZlbFxuICAgKiBAcGFyYW0ge051bWJlcn0gW2xpbWl0XSBsb2cgcGFnaW5hdGlvbiBsaW1pdFxuICAgKiBAcmV0dXJucyB7U3RyaW5nfSBzdHJhdGVneSBsb2cgbGlzdGVuZXIgaWRcbiAgICovXG4gIGFkZFN0cmF0ZWd5TG9nTGlzdGVuZXIobGlzdGVuZXIsIHN0cmF0ZWd5SWQsIHN0YXJ0VGltZSwgcG9zaXRpb25JZCwgbGV2ZWwsIGxpbWl0KSB7XG4gICAgY29uc3QgbGlzdGVuZXJJZCA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSgxMCk7XG4gICAgdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF0gPSBsaXN0ZW5lcjtcbiAgICB0aGlzLl9zdGFydFN0cmF0ZWd5TG9nU3RyZWFtSm9iKGxpc3RlbmVySWQsIGxpc3RlbmVyLCBzdHJhdGVneUlkLCBzdGFydFRpbWUsIHBvc2l0aW9uSWQsIGxldmVsLCBsaW1pdCk7XG4gICAgcmV0dXJuIGxpc3RlbmVySWQ7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIHN1YnNjcmliZXIgbG9nIGxpc3RlbmVyXG4gICAqIEBwYXJhbSB7VXNlckxvZ0xpc3RlbmVyfSBsaXN0ZW5lciB1c2VyIGxvZyBsaXN0ZW5lclxuICAgKiBAcGFyYW0ge1N0cmluZ30gc3Vic2NyaWJlcklkIHN1YnNjcmliZXIgaWRcbiAgICogQHBhcmFtIHtEYXRlfSBbc3RhcnRUaW1lXSBsb2cgc2VhcmNoIHN0YXJ0IHRpbWVcbiAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJhdGVneUlkXSBzdHJhdGVneSBpZCBmaWx0ZXJcbiAgICogQHBhcmFtIHtzdHJpbmd9IFtwb3NpdGlvbklkXSBwb3NpdGlvbiBpZCBmaWx0ZXJcbiAgICogQHBhcmFtIHsnREVCVUcnfCdJTkZPJ3wnV0FSTid8J0VSUk9SJ30gW2xldmVsXSBtaW5pbXVtIHNldmVyaXR5IGxldmVsXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBbbGltaXRdIGxvZyBwYWdpbmF0aW9uIGxpbWl0XG4gICAqIEByZXR1cm5zIHtTdHJpbmd9IHN1YnNjcmliZXIgbG9nIGxpc3RlbmVyIGlkXG4gICAqL1xuICBhZGRTdWJzY3JpYmVyTG9nTGlzdGVuZXIobGlzdGVuZXIsIHN1YnNjcmliZXJJZCwgc3RhcnRUaW1lLCBzdHJhdGVneUlkLCBwb3NpdGlvbklkLCBsZXZlbCwgbGltaXQpIHtcbiAgICBjb25zdCBsaXN0ZW5lcklkID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKDEwKTtcbiAgICB0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdID0gbGlzdGVuZXI7XG4gICAgdGhpcy5fc3RhcnRTdWJzY3JpYmVyTG9nU3RyZWFtSm9iKFxuICAgICAgbGlzdGVuZXJJZCwgXG4gICAgICBsaXN0ZW5lciwgXG4gICAgICBzdWJzY3JpYmVySWQsIFxuICAgICAgc3RhcnRUaW1lLCBcbiAgICAgIHN0cmF0ZWd5SWQsIFxuICAgICAgcG9zaXRpb25JZCwgXG4gICAgICBsZXZlbCwgXG4gICAgICBsaW1pdFxuICAgICk7XG4gICAgcmV0dXJuIGxpc3RlbmVySWQ7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBzdHJhdGVneSBsb2cgbGlzdGVuZXIgYnkgaWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGxpc3RlbmVySWQgbGlzdGVuZXIgaWQgXG4gICAqL1xuICByZW1vdmVTdHJhdGVneUxvZ0xpc3RlbmVyKGxpc3RlbmVySWQpIHtcbiAgICBkZWxldGUgdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF07XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lciBieSBpZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gbGlzdGVuZXJJZCBsaXN0ZW5lciBpZCBcbiAgICovXG4gIHJlbW92ZVN1YnNjcmliZXJMb2dMaXN0ZW5lcihsaXN0ZW5lcklkKSB7XG4gICAgZGVsZXRlIHRoaXMuX3N1YnNjcmliZXJMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF07XG4gIH1cblxuICBhc3luYyBfc3RhcnRTdHJhdGVneUxvZ1N0cmVhbUpvYihsaXN0ZW5lcklkLCBsaXN0ZW5lciwgc3RyYXRlZ3lJZCwgc3RhcnRUaW1lLCBwb3NpdGlvbklkLCBsZXZlbCwgbGltaXQpIHtcbiAgICBsZXQgdGhyb3R0bGVUaW1lID0gdGhpcy5fZXJyb3JUaHJvdHRsZVRpbWU7XG5cbiAgICB3aGlsZSh0aGlzLl9zdHJhdGVneUxvZ0xpc3RlbmVyc1tsaXN0ZW5lcklkXSkge1xuICAgICAgY29uc3Qgb3B0cyA9IHtcbiAgICAgICAgdXJsOiBgL3VzZXJzL2N1cnJlbnQvc3RyYXRlZ2llcy8ke3N0cmF0ZWd5SWR9L3VzZXItbG9nL3N0cmVhbWAsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHBhcmFtczoge1xuICAgICAgICAgIHN0YXJ0VGltZSxcbiAgICAgICAgICBwb3NpdGlvbklkLFxuICAgICAgICAgIGxldmVsLFxuICAgICAgICAgIGxpbWl0XG4gICAgICAgIH0sXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICAgIH0sXG4gICAgICAgIGpzb246IHRydWVcbiAgICAgIH07XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBwYWNrZXRzID0gYXdhaXQgdGhpcy5fZG9tYWluQ2xpZW50LnJlcXVlc3RDb3B5RmFjdG9yeShvcHRzLCB0cnVlKTtcbiAgICAgICAgLy8gc3RvcCBqb2IgaWYgdXNlciBoYXMgdW5zdWJzY3JpYmVkIGluIHRpbWUgb2YgbmV3IHBhY2tldHMgaGFzIGJlZW4gcmVjZWl2ZWRcbiAgICAgICAgaWYgKCF0aGlzLl9zdHJhdGVneUxvZ0xpc3RlbmVyc1tsaXN0ZW5lcklkXSkgeyByZXR1cm47IH1cbiAgICAgICAgYXdhaXQgbGlzdGVuZXIub25Vc2VyTG9nKHBhY2tldHMpO1xuICAgICAgICB0aHJvdHRsZVRpbWUgPSB0aGlzLl9lcnJvclRocm90dGxlVGltZTtcbiAgICAgICAgaWYodGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF0gJiYgcGFja2V0cy5sZW5ndGgpIHtcbiAgICAgICAgICBzdGFydFRpbWUgPSBuZXcgRGF0ZShuZXcgRGF0ZShwYWNrZXRzWzBdLnRpbWUpLmdldFRpbWUoKSArIDEpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgYXdhaXQgbGlzdGVuZXIub25FcnJvcihlcnIpO1xuICAgICAgICBpZiAoZXJyLm5hbWUgPT09ICdOb3RGb3VuZEVycm9yJykge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgU3RyYXRlZ3kgJHtzdHJhdGVneUlkfSBub3QgZm91bmQsIHJlbW92aW5nIGxpc3RlbmVyICR7bGlzdGVuZXJJZH1gKTtcbiAgICAgICAgICBkZWxldGUgdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF07IFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgRmFpbGVkIHRvIHJldHJpZXZlIHVzZXIgbG9nIHN0cmVhbSBmb3Igc3RyYXRlZ3kgJHtzdHJhdGVneUlkfSwgYCArXG4gICAgICAgICAgICBgbGlzdGVuZXIgJHtsaXN0ZW5lcklkfSwgcmV0cnlpbmcgaW4gJHtNYXRoLmZsb29yKHRocm90dGxlVGltZS8xMDAwKX0gc2Vjb25kc2AsIGVycik7XG4gICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCB0aHJvdHRsZVRpbWUpKTtcbiAgICAgICAgICB0aHJvdHRsZVRpbWUgPSBNYXRoLm1pbih0aHJvdHRsZVRpbWUgKiAyLCAzMDAwMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBfc3RhcnRTdWJzY3JpYmVyTG9nU3RyZWFtSm9iKFxuICAgIGxpc3RlbmVySWQsIFxuICAgIGxpc3RlbmVyLCBcbiAgICBzdWJzY3JpYmVySWQsIFxuICAgIHN0YXJ0VGltZSwgXG4gICAgc3RyYXRlZ3lJZCwgXG4gICAgcG9zaXRpb25JZCwgXG4gICAgbGV2ZWwsIFxuICAgIGxpbWl0XG4gICkge1xuICAgIGxldCB0aHJvdHRsZVRpbWUgPSB0aGlzLl9lcnJvclRocm90dGxlVGltZTtcblxuICAgIHdoaWxlKHRoaXMuX3N1YnNjcmliZXJMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF0pIHtcbiAgICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICAgIHVybDogYC91c2Vycy9jdXJyZW50L3N1YnNjcmliZXJzLyR7c3Vic2NyaWJlcklkfS91c2VyLWxvZy9zdHJlYW1gLFxuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgICAgc3RyYXRlZ3lJZCxcbiAgICAgICAgICBwb3NpdGlvbklkLFxuICAgICAgICAgIGxldmVsLFxuICAgICAgICAgIGxpbWl0XG4gICAgICAgIH0sXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICAgIH0sXG4gICAgICAgIGpzb246IHRydWVcbiAgICAgIH07XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBwYWNrZXRzID0gYXdhaXQgdGhpcy5fZG9tYWluQ2xpZW50LnJlcXVlc3RDb3B5RmFjdG9yeShvcHRzLCB0cnVlKTtcbiAgICAgICAgLy8gc3RvcCBqb2IgaWYgdXNlciBoYXMgdW5zdWJzY3JpYmVkIGluIHRpbWUgb2YgbmV3IHBhY2tldHMgaGFzIGJlZW4gcmVjZWl2ZWRcbiAgICAgICAgaWYgKCF0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdKSB7IHJldHVybjsgfVxuICAgICAgICBhd2FpdCBsaXN0ZW5lci5vblVzZXJMb2cocGFja2V0cyk7XG4gICAgICAgIHRocm90dGxlVGltZSA9IHRoaXMuX2Vycm9yVGhyb3R0bGVUaW1lO1xuICAgICAgICBpZih0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdICYmIHBhY2tldHMubGVuZ3RoKSB7XG4gICAgICAgICAgc3RhcnRUaW1lID0gbmV3IERhdGUobmV3IERhdGUocGFja2V0c1swXS50aW1lKS5nZXRUaW1lKCkgKyAxKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGF3YWl0IGxpc3RlbmVyLm9uRXJyb3IoZXJyKTtcbiAgICAgICAgaWYgKGVyci5uYW1lID09PSAnTm90Rm91bmRFcnJvcicpIHtcbiAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYFN1YnNjcmliZXIgJHtzdWJzY3JpYmVySWR9IG5vdCBmb3VuZCwgcmVtb3ZpbmcgbGlzdGVuZXIgJHtsaXN0ZW5lcklkfWApO1xuICAgICAgICAgIGRlbGV0ZSB0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdOyBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byByZXRyaWV2ZSB1c2VyIGxvZyBzdHJlYW0gZm9yIHN1YnNjcmliZXIgJHtzdWJzY3JpYmVySWR9LCBgICtcbiAgICAgICAgICAgIGBsaXN0ZW5lciAke2xpc3RlbmVySWR9LCByZXRyeWluZyBpbiAke01hdGguZmxvb3IodGhyb3R0bGVUaW1lLzEwMDApfSBzZWNvbmRzYCwgZXJyKTtcbiAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIHRocm90dGxlVGltZSkpO1xuICAgICAgICAgIHRocm90dGxlVGltZSA9IE1hdGgubWluKHRocm90dGxlVGltZSAqIDIsIDMwMDAwKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG59XG4iXSwibmFtZXMiOlsiTWV0YUFwaUNsaWVudCIsInJhbmRvbXN0cmluZyIsIkxvZ2dlck1hbmFnZXIiLCJVc2VyTG9nTGlzdGVuZXJNYW5hZ2VyIiwic3RyYXRlZ3lMb2dMaXN0ZW5lcnMiLCJfc3RyYXRlZ3lMb2dMaXN0ZW5lcnMiLCJzdWJzY3JpYmVyTG9nTGlzdGVuZXJzIiwiX3N1YnNjcmliZXJMb2dMaXN0ZW5lcnMiLCJhZGRTdHJhdGVneUxvZ0xpc3RlbmVyIiwibGlzdGVuZXIiLCJzdHJhdGVneUlkIiwic3RhcnRUaW1lIiwicG9zaXRpb25JZCIsImxldmVsIiwibGltaXQiLCJsaXN0ZW5lcklkIiwiZ2VuZXJhdGUiLCJfc3RhcnRTdHJhdGVneUxvZ1N0cmVhbUpvYiIsImFkZFN1YnNjcmliZXJMb2dMaXN0ZW5lciIsInN1YnNjcmliZXJJZCIsIl9zdGFydFN1YnNjcmliZXJMb2dTdHJlYW1Kb2IiLCJyZW1vdmVTdHJhdGVneUxvZ0xpc3RlbmVyIiwicmVtb3ZlU3Vic2NyaWJlckxvZ0xpc3RlbmVyIiwidGhyb3R0bGVUaW1lIiwiX2Vycm9yVGhyb3R0bGVUaW1lIiwib3B0cyIsInVybCIsIm1ldGhvZCIsInBhcmFtcyIsImhlYWRlcnMiLCJfdG9rZW4iLCJqc29uIiwicGFja2V0cyIsIl9kb21haW5DbGllbnQiLCJyZXF1ZXN0Q29weUZhY3RvcnkiLCJvblVzZXJMb2ciLCJsZW5ndGgiLCJEYXRlIiwidGltZSIsImdldFRpbWUiLCJlcnIiLCJvbkVycm9yIiwibmFtZSIsIl9sb2dnZXIiLCJlcnJvciIsIk1hdGgiLCJmbG9vciIsIlByb21pc2UiLCJyZXMiLCJzZXRUaW1lb3V0IiwibWluIiwiY29uc3RydWN0b3IiLCJkb21haW5DbGllbnQiLCJnZXRMb2dnZXIiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQSxPQUFPQSxtQkFBbUIsdUJBQXVCO0FBQ2pELE9BQU9DLGtCQUFrQixlQUFlO0FBQ3hDLE9BQU9DLG1CQUFtQixrQkFBa0I7QUFLN0IsSUFBQSxBQUFNQyx5QkFBTixNQUFNQSwrQkFBK0JIO0lBZWxEOzs7R0FHQyxHQUNELElBQUlJLHVCQUF1QjtRQUN6QixPQUFPLElBQUksQ0FBQ0MscUJBQXFCO0lBQ25DO0lBRUE7OztHQUdDLEdBQ0QsSUFBSUMseUJBQXlCO1FBQzNCLE9BQU8sSUFBSSxDQUFDQyx1QkFBdUI7SUFDckM7SUFFQTs7Ozs7Ozs7O0dBU0MsR0FDREMsdUJBQXVCQyxRQUFRLEVBQUVDLFVBQVUsRUFBRUMsU0FBUyxFQUFFQyxVQUFVLEVBQUVDLEtBQUssRUFBRUMsS0FBSyxFQUFFO1FBQ2hGLE1BQU1DLGFBQWFkLGFBQWFlLFFBQVEsQ0FBQztRQUN6QyxJQUFJLENBQUNYLHFCQUFxQixDQUFDVSxXQUFXLEdBQUdOO1FBQ3pDLElBQUksQ0FBQ1EsMEJBQTBCLENBQUNGLFlBQVlOLFVBQVVDLFlBQVlDLFdBQVdDLFlBQVlDLE9BQU9DO1FBQ2hHLE9BQU9DO0lBQ1Q7SUFFQTs7Ozs7Ozs7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